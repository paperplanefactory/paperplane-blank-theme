let searchData=[],searchConfig={},jsonLoaded=!1,selectedIndex=-1;async function fetchLatestJsonUrl(){try{const e=window.location.origin+'/wp-json/custom/v1/latest-json-url/',t=await fetch(e);if(!t.ok)throw new Error('Errore REST API: '+t.status+' '+t.statusText);const r=await t.json();if(!r.jsonUrl||!r.gzipUrl)throw new Error('Dati REST API incompleti: jsonUrl o gzipUrl mancanti');return searchConfig={jsonUrl:r.jsonUrl,gzipUrl:r.gzipUrl,postTypePriorities:r.postTypePriorities||{}},searchConfig}catch(e){throw console.error('ERRORE nel caricamento della REST API:',e),e}}function debounce(e,t){let r;return function(){const o=arguments;clearTimeout(r),r=setTimeout(()=>e.apply(this,o),t)}}function getWordVariations(e){const t=new Set([e.toLowerCase()]);return[{from:/i$/i,to:'o'},{from:/e$/i,to:'a'},{from:/i$/i,to:'e'},{from:/o$/i,to:'i'},{from:/a$/i,to:'e'},{from:/e$/i,to:'i'}].concat([{from:/chi$/i,to:'co'},{from:/che$/i,to:'ca'},{from:/ghi$/i,to:'go'},{from:/ghe$/i,to:'ga'},{from:/co$/i,to:'chi'},{from:/ca$/i,to:'che'},{from:/go$/i,to:'ghi'},{from:/ga$/i,to:'ghe'}]).forEach((function(r){e.match(r.from)&&t.add(e.replace(r.from,r.to).toLowerCase())})),Array.from(t)}function handleExceptions(e){const t={uomo:'uomini',uomini:'uomo',dio:'dei',dei:'dio',bue:'buoi',buoi:'bue'};return new Set(['città','virtù','gioventù','caffè','computer','sport']).has(e.toLowerCase())?[e.toLowerCase()]:t[e.toLowerCase()]?[e.toLowerCase(),t[e.toLowerCase()]]:null}function getNormalizedWords(e){const t=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();return handleExceptions(t)||getWordVariations(t)}function removeAccents(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function updateSelectedItem(e,t){if(e.forEach((function(e,r){if(r===t){e.setAttribute('aria-selected','true');const t=document.getElementById('search-input');t&&t.setAttribute('aria-activedescendant',e.id)}else e.setAttribute('aria-selected','false')})),-1===t){const e=document.getElementById('search-input');e&&e.removeAttribute('aria-activedescendant')}}document.addEventListener('DOMContentLoaded',(function(){const e=document.getElementById('search-input'),t=document.getElementById('search-suggestions'),r=document.getElementById('search-status-js'),o={closeSearchResults:'undefined'!=typeof themeStrings&&themeStrings.closeSearchResults?themeStrings.closeSearchResults:'Chiudi risultati ricerca',searchResultSingular:'undefined'!=typeof themeStrings&&themeStrings.searchResultSingular?themeStrings.searchResultSingular:'risultato',searchResultPlural:'undefined'!=typeof themeStrings&&themeStrings.searchResultPlural?themeStrings.searchResultPlural:'risultati',noSearchResults:'undefined'!=typeof themeStrings&&themeStrings.noSearchResults?themeStrings.noSearchResults:'0 risultati',proceedToView:'undefined'!=typeof themeStrings&&themeStrings.proceedToView?themeStrings.proceedToView:', prosegui per visualizzare',searchSuggestions:'undefined'!=typeof themeStrings&&themeStrings.searchSuggestions?themeStrings.searchSuggestions:'Suggerimenti di ricerca',searchElementsNotFound:'undefined'!=typeof themeStrings&&themeStrings.searchElementsNotFound?themeStrings.searchElementsNotFound:'Elementi di ricerca non trovati',fallbackUncompressed:'undefined'!=typeof themeStrings&&themeStrings.fallbackUncompressed?themeStrings.fallbackUncompressed:'Fallback alla versione non compressa',errorLoadingJSON:'undefined'!=typeof themeStrings&&themeStrings.errorLoadingJSON?themeStrings.errorLoadingJSON:'Errore nel caricamento del JSON',errorLoading:'undefined'!=typeof themeStrings&&themeStrings.errorLoading?themeStrings.errorLoading:'Errore nel caricamento:',errorLoadingData:'undefined'!=typeof themeStrings&&themeStrings.errorLoadingData?themeStrings.errorLoadingData:'Errore caricamento dati:'};function s(e){const t=searchConfig.postTypePriorities||{};return parseInt(t[e])||999}if(!e||!t)return void console.error(o.searchElementsNotFound);function n(){const n=e.value.toLowerCase();if(n.length>=3?e.classList.add('has-text'):e.classList.remove('has-text'),n.length<3){t.classList.remove('visible'),e.setAttribute('aria-expanded','false'),e.removeAttribute('aria-activedescendant');const o=document.getElementById('search-close-button');return o&&o.classList.remove('visible'),void(r&&n.length>0&&(r.textContent='Digita almeno 3 caratteri'))}const i=searchData.filter(e=>{const t=n.split(' ').filter(e=>e.length>0),r=t.map(e=>getNormalizedWords(e)).flat();e.matchScore=0;const o=t.some(t=>removeAccents(e.title.toLowerCase()).includes(t.toLowerCase()));o&&(e.matchScore+=100);const s=r.some(t=>removeAccents(e.title.toLowerCase()).includes(t));s&&!o&&(e.matchScore+=50);const i=e.searchable_content&&t.some(t=>removeAccents(e.searchable_content.toLowerCase()).includes(t.toLowerCase()));i&&(e.matchScore+=30);const a=e.searchable_content&&r.some(t=>removeAccents(e.searchable_content.toLowerCase()).includes(t));return a&&!i&&(e.matchScore+=10),s||a||o||i}).sort((e,t)=>{const r=s(e.post_type),o=s(t.post_type);return r!==o?r-o:e.matchScore!==t.matchScore?t.matchScore-e.matchScore:new Date(t.modified)-new Date(e.modified)}).slice(0,30);if(i.length>0){selectedIndex=-1;const s=i.length,n='<li class="search-result-counter" aria-hidden="true" aria-selected="false" role="option" tabindex="-1">'+s+' '+(1===s?o.searchResultSingular:o.searchResultPlural)+'</li>',a=i.map((e,t)=>"<li class=\"suggestion-item\" aria-selected=\"false\" id=\"search-suggestion-"+t+'" role="option" tabindex="-1" aria-posinset="'+(t+1)+'" aria-setsize="'+i.length+'">'+(e.featured_image?'<div class="suggestion-image"><img src="'+e.featured_image+'" alt="" loading="lazy" decoding="async" /></div>':'')+'<div class="suggestion-title" aria-hidden="true">'+e.title+"</div><a href=\""+e.url+'" class="absl"><span class="screen-reader-text">'+e.title+"</span></a></li>").join('');t.innerHTML=n+a,t.classList.add('visible'),e.setAttribute('aria-expanded','true');const c=document.getElementById('search-close-button');if(c&&c.classList.add('visible'),r){const e=1===s?o.searchResultSingular:o.searchResultPlural;r.textContent=s+' '+e+o.proceedToView}}else{t.classList.remove('visible'),e.setAttribute('aria-expanded','false'),e.removeAttribute('aria-activedescendant'),selectedIndex=-1;const s=document.getElementById('search-close-button');s&&s.classList.remove('visible'),r&&(r.textContent=o.noSearchResults)}}e.addEventListener('focus',(function(){r&&r.setAttribute('aria-hidden','false'),jsonLoaded||async function(){try{for(;!searchConfig.jsonUrl||!searchConfig.gzipUrl;)await new Promise(e=>setTimeout(e,50));if(searchConfig.gzipUrl)try{const e=await fetch(searchConfig.gzipUrl,{headers:{'Accept-Encoding':'gzip'}});if(e.ok)return await e.json()}catch(e){console.warn(o.fallbackUncompressed,e)}const e=await fetch(searchConfig.jsonUrl);if(!e.ok)throw new Error(o.errorLoadingJSON);return await e.json()}catch(e){throw console.error(o.errorLoading,e),e}}().then(t=>{searchData=Object.values(t),jsonLoaded=!0,e.value.length>=3&&n()}).catch(e=>{console.error(o.errorLoadingData,e)})}));const i=debounce(n,300);e.addEventListener('input',i),e.addEventListener('keydown',(function(r){const o=Array.from(t.querySelectorAll('.suggestion-item'));if(0!==o.length){if('ArrowDown'===r.key&&(r.preventDefault(),selectedIndex=Math.min(selectedIndex+1,o.length-1),updateSelectedItem(o,selectedIndex)),'ArrowUp'===r.key&&(r.preventDefault(),selectedIndex=Math.max(selectedIndex-1,-1),updateSelectedItem(o,selectedIndex)),'Enter'===r.key&&selectedIndex>=0){r.preventDefault();const e=o[selectedIndex].querySelector('.absl');e&&e.click()}if('Escape'===r.key){r.preventDefault(),t.classList.remove('visible'),e.setAttribute('aria-expanded','false'),e.removeAttribute('aria-activedescendant'),selectedIndex=-1,updateSelectedItem(o,selectedIndex);const s=document.getElementById('search-close-button');s&&s.classList.remove('visible')}}}));const a=document.getElementById('search-close-button');a&&a.addEventListener('click',(function(r){r.preventDefault(),t.classList.remove('visible'),e.setAttribute('aria-expanded','false'),e.removeAttribute('aria-activedescendant'),selectedIndex=-1,a.classList.remove('visible'),jsonLoaded=!1,a.focus()})),fetchLatestJsonUrl().catch(e=>{console.error('❌ Errore nel caricamento della REST API:',e)})}));